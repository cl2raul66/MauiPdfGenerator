name: Publish Core Solution

on:
  workflow_dispatch:
  push:
    branches: [ "development", "master" ]
    paths:
      - 'MauiPdfGenerator/**'
      - 'MauiPdfGenerator.Diagnostics/**'

jobs:
  # -----------------------------------------------------------------
  # JOB 1: DIAGNOSTICS
  # -----------------------------------------------------------------
  build-diagnostics:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.final_version.outputs.VAL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI Workloads
        run: dotnet workload install maui --ignore-failed-sources

      - name: Calculate Version
        id: versioning
        uses: PaulHatch/semantic-version@v5.4.0
        with:
          tag_prefix: "diag-v"
          major_pattern: "(MAJOR)"
          minor_pattern: "(MINOR)|feat|feature"
          version_format: "${major}.${minor}.${patch}"
          change_path: "MauiPdfGenerator.Diagnostics"
          user_format_type: "json"

      - name: Determine Version String
        id: final_version
        shell: pwsh
        run: |
          if ("${{ github.ref }}" -eq "refs/heads/master") {
            echo "VAL=${{ steps.versioning.outputs.version }}" >> $env:GITHUB_OUTPUT
          } else {
            echo "VAL=${{ steps.versioning.outputs.version }}-preview-${{ steps.versioning.outputs.increment }}" >> $env:GITHUB_OUTPUT
          }

      - name: Build & Pack Diagnostics
        run: |
          $ver = "${{ steps.final_version.outputs.VAL }}"
          Write-Host "Empaquetando Diagnostics: $ver"
          
          # Restore y Build en Release
          dotnet restore MauiPdfGenerator.Diagnostics/MauiPdfGenerator.Diagnostics.csproj
          dotnet build MauiPdfGenerator.Diagnostics/MauiPdfGenerator.Diagnostics.csproj --configuration Release --no-restore
          dotnet pack MauiPdfGenerator.Diagnostics/MauiPdfGenerator.Diagnostics.csproj --configuration Release --no-build --output ./output /p:Version=$ver

      - name: Upload Diagnostics Artifact
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-package
          path: ./output/*.nupkg
          retention-days: 1

  # -----------------------------------------------------------------
  # JOB 2: MAIN LIBRARY
  # -----------------------------------------------------------------
  build-main:
    needs: build-diagnostics
    runs-on: windows-latest
    outputs:
      version: ${{ steps.final_version.outputs.VAL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI Workloads
        run: dotnet workload install maui --ignore-failed-sources

      # Descargar el artefacto de Diagnostics
      - name: Download Diagnostics Artifact
        uses: actions/download-artifact@v4
        with:
          name: diagnostics-package
          path: ./local-feed

      # Configurar Fuente Local
      - name: Setup Local NuGet Feed
        run: dotnet nuget add source "${{ github.workspace }}/local-feed" --name LocalArtifacts

      # Cálculo de Versión Main (Con Cascada)
      - name: Calculate Version
        id: versioning
        uses: PaulHatch/semantic-version@v5.4.0
        with:
          tag_prefix: "main-v"
          major_pattern: "(MAJOR)"
          minor_pattern: "(MINOR)|feat|feature"
          version_format: "${major}.${minor}.${patch}"
          # Vigilamos ambas carpetas para el efecto cascada
          change_path: "MauiPdfGenerator MauiPdfGenerator.Diagnostics"
          user_format_type: "json"

      - name: Determine Version String
        id: final_version
        shell: pwsh
        run: |
          if ("${{ github.ref }}" -eq "refs/heads/master") {
            echo "VAL=${{ steps.versioning.outputs.version }}" >> $env:GITHUB_OUTPUT
          } else {
            echo "VAL=${{ steps.versioning.outputs.version }}-preview-${{ steps.versioning.outputs.increment }}" >> $env:GITHUB_OUTPUT
          }

      - name: Build & Pack Main
        run: |
          $mainVer = "${{ steps.final_version.outputs.VAL }}"
          # Usamos la versión que nos pasó el Job 1 (Garantía de coincidencia)
          $diagVer = "${{ needs.build-diagnostics.outputs.version }}"
          
          Write-Host "Empaquetando Main: $mainVer (Dependencia Diagnostics: $diagVer)"

          # CORRECCIÓN CRÍTICA: Agregado '-c Release' al restore
          dotnet restore MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release /p:Version=$mainVer /p:DiagnosticsVersion=$diagVer
          
          dotnet build MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-restore /p:Version=$mainVer /p:DiagnosticsVersion=$diagVer
          dotnet pack MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-build --output ./output /p:Version=$mainVer /p:DiagnosticsVersion=$diagVer

      - name: Upload Main Artifact
        uses: actions/upload-artifact@v4
        with:
          name: main-package
          path: ./output/*.nupkg
          retention-days: 1

  # -----------------------------------------------------------------
  # JOB 3: PUBLICACIÓN
  # -----------------------------------------------------------------
  publish-nuget:
    needs: [build-diagnostics, build-main]
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      # Instalar .NET para tener el comando nuget
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./packages
          merge-multiple: true

      - name: Publish to NuGet
        shell: pwsh
        run: |
          $packages = Get-ChildItem ./packages/*.nupkg
          foreach ($pkg in $packages) {
              Write-Host "Publicando: $($pkg.Name)"
              dotnet nuget push $pkg.FullName --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          }

      - name: Create Tags
        if: github.ref == 'refs/heads/master'
        uses: actions/github-script@v7
        with:
          script: |
            const diagVer = "${{ needs.build-diagnostics.outputs.version }}";
            const mainVer = "${{ needs.build-main.outputs.version }}";
            
            async function tryCreateTag(tagName) {
              try {
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${tagName}`,
                  sha: context.sha
                });
                console.log(`Tag creado: ${tagName}`);
              } catch (e) {
                console.log(`Tag ${tagName} no creado (ya existe o sin cambios).`);
              }
            }

            await tryCreateTag(`diag-v${diagVer}`);
            await tryCreateTag(`main-v${mainVer}`);