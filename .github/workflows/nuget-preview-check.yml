name: NuGet Preview Check

on:
  workflow_dispatch:

jobs:
  check-previews:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Check local stable tags
        run: |
          echo "=== LOCAL STABLE TAGS ==="
          echo "Main stable: $(git describe --tags --match 'main-v*' --abbrev=0 2>/dev/null || echo 'NOT FOUND')"
          echo "Gen stable: $(git describe --tags --match 'gen-v*' --abbrev=0 2>/dev/null || echo 'NOT FOUND')"
          echo ""
          echo "Local preview tags:"
          git tag -l "main-v*preview*" 2>/dev/null || echo "  None"
          git tag -l "gen-v*preview*" 2>/dev/null || echo "  None"

      - name: Check NuGet for MauiPdfGenerator
        id: core
        run: |
          echo ""
          echo "=== NUGET: MauiPdfGenerator ==="
          CORE_PKG="RandAMediaLabGroup.MauiPdfGenerator"
          CORE_STABLE=$(git describe --tags --match 'main-v*' --abbrev=0 2>/dev/null | sed 's/main-v//')
          echo "Local stable: $CORE_STABLE"

          CORE_LATEST=$(curl -s "https://api.nuget.org/v3-flatcontainer/$CORE_PKG/index.json" | grep -o '"[^"]*"' | tr -d '"' | grep '^1\.' | tail -1)
          echo "Latest NuGet: $CORE_LATEST"

          if [[ "$CORE_LATEST" == *"preview"* ]]; then
            CORE_BASE=$(echo "$CORE_LATEST" | sed 's/-preview-[0-9]*//')
            echo "Base version: $CORE_BASE"

            if [[ -z "$CORE_STABLE" ]] || [[ "$(printf '%s\n' "$CORE_BASE" "$CORE_STABLE" | sort -V | tail -n1)" == "$CORE_BASE" && "$CORE_BASE" != "$CORE_STABLE" ]]; then
              echo "RESULT: SHOULD_PROMOTE_CORE=true"
              echo "should_promote_core=true" >> $GITHUB_OUTPUT
            else
              echo "RESULT: SHOULD_PROMOTE_CORE=false"
              echo "should_promote_core=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Latest is stable, no action needed"
            echo "should_promote_core=false" >> $GITHUB_OUTPUT
          fi

      - name: Check NuGet for SourceGenerators
        id: gen
        run: |
          echo ""
          echo "=== NUGET: SourceGenerators ==="
          GEN_PKG="RandAMediaLabGroup.MauiPdfGenerator.SourceGenerators"
          GEN_STABLE=$(git describe --tags --match 'gen-v*' --abbrev=0 2>/dev/null | sed 's/gen-v//')
          echo "Local stable: $GEN_STABLE"

          GEN_LATEST=$(curl -s "https://api.nuget.org/v3-flatcontainer/$GEN_PKG/index.json" | grep -o '"[^"]*"' | tr -d '"' | grep '^1\.' | tail -1)
          echo "Latest NuGet: $GEN_LATEST"

          if [[ "$GEN_LATEST" == *"preview"* ]]; then
            GEN_BASE=$(echo "$GEN_LATEST" | sed 's/-preview-[0-9]*//')
            echo "Base version: $GEN_BASE"

            if [[ -z "$GEN_STABLE" ]] || [[ "$(printf '%s\n' "$GEN_BASE" "$GEN_STABLE" | sort -V | tail -n1)" == "$GEN_BASE" && "$GEN_BASE" != "$GEN_STABLE" ]]; then
              echo "RESULT: SHOULD_PROMOTE_GEN=true"
              echo "should_promote_gen=true" >> $GITHUB_OUTPUT
            else
              echo "RESULT: SHOULD_PROMOTE_GEN=false"
              echo "should_promote_gen=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Latest is stable, no action needed"
            echo "should_promote_gen=false" >> $GITHUB_OUTPUT
          fi

      - name: Final Summary
        run: |
          CORE_SHOULD=$(cat $GITHUB_OUTPUT | grep should_promote_core | cut -d= -f2)
          GEN_SHOULD=$(cat $GITHUB_OUTPUT | grep should_promote_gen | cut -d= -f2)

          echo ""
          echo "========================================"
          echo "FINAL RESULT"
          echo "========================================"
          echo "MauiPdfGenerator should promote: $CORE_SHOULD"
          echo "SourceGenerators should promote: $GEN_SHOULD"
          echo ""

          if [[ "$CORE_SHOULD" == "true" ]] || [[ "$GEN_SHOULD" == "true" ]]; then
            echo "========================================"
            echo "PREVIEWS PENDING - RUN PRODUCTION RELEASE"
            echo "https://github.com/cl2raul66/MauiPdfGenerator/actions/workflows/prod-release.yml"
            echo "========================================"
            exit 1
          else
            echo "========================================"
            echo "NO PREVIEWS PENDING"
            echo "========================================"
            exit 0
          fi
