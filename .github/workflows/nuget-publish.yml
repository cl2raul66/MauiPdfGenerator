name: Build & Publish NuGet

on:
  push:
    branches: [ master ]
    paths-ignore:
      - '**/*.md'
      - '.github/**'
      - 'LICENSE.txt'
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Ejecutar publicación manual'
        required: false
        default: true
        type: boolean

jobs:
  # TRABAJO 1: COMPILAR Y EMPAQUETAR
  build-and-pack:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Configuración para .NET 10 Preview
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      # 1. Diagnostics
      - name: Build & Pack Diagnostics
        run: |
          dotnet restore MauiPdfGenerator.Diagnostics/MauiPdfGenerator.Diagnostics.csproj
          dotnet build MauiPdfGenerator.Diagnostics/MauiPdfGenerator.Diagnostics.csproj -c Release --no-restore
          dotnet pack MauiPdfGenerator.Diagnostics/MauiPdfGenerator.Diagnostics.csproj -c Release --no-build -o ./nupkgs

      # 2. Main Library
      - name: Build & Pack Main Library
        run: |
          dotnet restore MauiPdfGenerator/MauiPdfGenerator.csproj
          dotnet build MauiPdfGenerator/MauiPdfGenerator.csproj -c Release --no-restore
          dotnet pack MauiPdfGenerator/MauiPdfGenerator.csproj -c Release --no-build -o ./nupkgs

      # 3. Source Generators
      - name: Build & Pack SourceGenerators
        run: |
          dotnet restore MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj
          dotnet build MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj -c Release --no-restore
          dotnet pack MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj -c Release --no-build -o ./nupkgs

      # Guardar artefactos
      - name: Upload NuGet Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./nupkgs/*.nupkg
          retention-days: 5

  # TRABAJO 2: PUBLICAR CON ADVERTENCIAS
  publish-nuget:
    needs: build-and-pack
    runs-on: windows-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./nupkgs

      - name: Publish to NuGet with Warnings
        shell: pwsh
        run: |
          $packages = Get-ChildItem ./nupkgs/*.nupkg
          $apiKey = "${{ secrets.NUGET_API_KEY }}"
          $source = "https://api.nuget.org/v3/index.json"
          $hasErrors = $false

          foreach ($package in $packages) {
              Write-Host "Procesando: $($package.Name)"
              
              # Ejecutamos el push y capturamos TODA la salida (éxito y error)
              # Usamos --skip-duplicate para que no lance excepción, pero leemos el texto
              $output = dotnet nuget push $package.FullName --api-key $apiKey --source $source --skip-duplicate 2>&1 | Out-String

              Write-Host $output

              # ANÁLISIS DE RESULTADOS
              if ($output -match "already exists" -or $output -match "409") {
                  # CASO: VERSIÓN DUPLICADA -> Generamos ADVERTENCIA de GitHub
                  # Esto crea una caja amarilla en la UI de GitHub Actions
                  Write-Host "::warning title=Versión Duplicada::$($package.Name) ya existe en NuGet. No se publicó nada. Recuerda subir la versión en el .csproj."
              }
              elseif ($output -match "Pushed") {
                  # CASO: ÉXITO
                  Write-Host "::notice title=Publicado::$($package.Name) se ha publicado correctamente."
              }
              elseif ($LASTEXITCODE -ne 0) {
                  # CASO: ERROR REAL (Red, Auth, etc)
                  Write-Host "::error title=Error Crítico::Fallo al publicar $($package.Name)."
                  $hasErrors = $true
              }
          }

          if ($hasErrors) {
              exit 1
          }