name: Production Release (Stable)

on:
  pull_request:
    types: [closed]
    branches: 
      - master

permissions:
  contents: write
  pull-requests: read

jobs:
  publish-stable:
    if: github.event.pull_request.merged == true
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract versions from PR body
        id: extract_version
        shell: pwsh
        run: |
          $prBody = @'
          ${{ github.event.pull_request.body }}
          '@
          
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ğŸ“‹ Analizando cuerpo del PR para promociÃ³n a STABLE"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Buscar ver(main): x.x.x-preview
          $mainPreview = $null
          $mainStable = $null
          if ($prBody -match '(?i)ver\s*\(\s*main\s*\)\s*:\s*(\d+\.\d+\.\d+)-preview') {
            $mainPreview = $matches[1] + "-preview"
            $mainStable = $matches[1]
            Write-Host "âœ… ver(main) encontrado"
            Write-Host "   Preview: $mainPreview"
            Write-Host "   Stable:  $mainStable"
          } else {
            Write-Host "âš ï¸  ver(main) no encontrado - se omitirÃ¡ paquete Core"
          }
          
          # Buscar ver(sourceGenerators): x.x.x-preview
          $sourceGenPreview = $null
          $sourceGenStable = $null
          if ($prBody -match '(?i)ver\s*\(\s*sourceGenerators\s*\)\s*:\s*(\d+\.\d+\.\d+)-preview') {
            $sourceGenPreview = $matches[1] + "-preview"
            $sourceGenStable = $matches[1]
            Write-Host "âœ… ver(sourceGenerators) encontrado"
            Write-Host "   Preview: $sourceGenPreview"
            Write-Host "   Stable:  $sourceGenStable"
          } else {
            Write-Host "âš ï¸  ver(sourceGenerators) no encontrado - se omitirÃ¡ paquete SourceGenerators"
          }
          
          # Validar que al menos uno fue encontrado
          if (-not $mainStable -and -not $sourceGenStable) {
            Write-Host ""
            Write-Host "âŒ ERROR: No se encontrÃ³ ninguna versiÃ³n vÃ¡lida"
            Write-Host "   Formato esperado:"
            Write-Host "   ver(main): 1.5.13-preview"
            Write-Host "   ver(sourceGenerators): 1.3.5-preview"
            exit 1
          }
          
          # Exportar variables
          echo "MAIN_PREVIEW=$mainPreview" >> $env:GITHUB_OUTPUT
          echo "MAIN_STABLE=$mainStable" >> $env:GITHUB_OUTPUT
          echo "SOURCEGEN_PREVIEW=$sourceGenPreview" >> $env:GITHUB_OUTPUT
          echo "SOURCEGEN_STABLE=$sourceGenStable" >> $env:GITHUB_OUTPUT
          echo "HAS_MAIN=$($null -ne $mainStable)" >> $env:GITHUB_OUTPUT
          echo "HAS_SOURCEGEN=$($null -ne $sourceGenStable)" >> $env:GITHUB_OUTPUT
          
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Update project versions
        shell: pwsh
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ğŸ”§ Actualizando versiones a STABLE"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Actualizar MauiPdfGenerator
          if ("${{ steps.extract_version.outputs.HAS_MAIN }}" -eq "True") {
            $version = "${{ steps.extract_version.outputs.MAIN_STABLE }}"
            $coreProj = "MauiPdfGenerator/MauiPdfGenerator.csproj"
            (Get-Content $coreProj) -replace '<Version>.*</Version>', "<Version>$version</Version>" | Set-Content $coreProj
            Write-Host "âœ… Core actualizado a: $version (STABLE)"
          } else {
            Write-Host "â­ï¸  Core omitido (no hay versiÃ³n)"
          }
          
          # Actualizar SourceGenerators
          if ("${{ steps.extract_version.outputs.HAS_SOURCEGEN }}" -eq "True") {
            $version = "${{ steps.extract_version.outputs.SOURCEGEN_STABLE }}"
            $sourceGenProj = "MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj"
            (Get-Content $sourceGenProj) -replace '<Version>.*</Version>', "<Version>$version</Version>" | Set-Content $sourceGenProj
            Write-Host "âœ… SourceGenerators actualizado a: $version (STABLE)"
          } else {
            Write-Host "â­ï¸  SourceGenerators omitido (no hay versiÃ³n)"
          }
          
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI Workloads
        run: dotnet workload install maui --ignore-failed-sources

      - name: Restore dependencies
        run: dotnet restore MauiPdfGenerator.sln

      - name: Build Core package
        if: steps.extract_version.outputs.HAS_MAIN == 'True'
        run: dotnet build MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-restore

      - name: Build SourceGenerators package
        if: steps.extract_version.outputs.HAS_SOURCEGEN == 'True'
        run: dotnet build MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj --configuration Release --no-restore

      - name: Pack Core package
        if: steps.extract_version.outputs.HAS_MAIN == 'True'
        run: dotnet pack MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-build --output ./nupkgs

      - name: Pack SourceGenerators package
        if: steps.extract_version.outputs.HAS_SOURCEGEN == 'True'
        run: dotnet pack MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj --configuration Release --no-build --output ./nupkgs

      - name: List generated packages
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Paquetes generados (STABLE):"
          if (Test-Path ./nupkgs) {
            Get-ChildItem ./nupkgs/*.nupkg | ForEach-Object { Write-Host "  - $($_.Name)" }
          } else {
            Write-Host "  âš ï¸  No se generaron paquetes"
          }

      - name: Publish to NuGet
        shell: pwsh
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          if (-not (Test-Path ./nupkgs)) {
            Write-Host "âš ï¸  No hay paquetes para publicar"
            exit 0
          }
          
          $packages = Get-ChildItem ./nupkgs/*.nupkg
          $publishedCount = 0
          $skippedCount = 0
          
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ğŸ“¤ Publicando paquetes STABLE a NuGet"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          foreach ($package in $packages) {
            Write-Host ""
            Write-Host "Procesando: $($package.Name)"
            
            try {
              $output = dotnet nuget push $package.FullName --api-key $env:NUGET_API_KEY --source https://api.nuget.org/v3/index.json --skip-duplicate 2>&1
              
              if ($LASTEXITCODE -eq 0) {
                if ($output -match "already exists") {
                  Write-Host "â­ï¸  Ya existe en NuGet - omitido"
                  $skippedCount++
                } else {
                  Write-Host "âœ… Publicado exitosamente"
                  $publishedCount++
                }
              } else {
                Write-Host "âš ï¸  Advertencia: $output"
                $skippedCount++
              }
            } catch {
              Write-Host "âš ï¸  Error capturado: $($_.Exception.Message)"
              $skippedCount++
            }
          }
          
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ğŸ“Š Resumen:"
          Write-Host "   âœ… Publicados: $publishedCount"
          Write-Host "   â­ï¸  Omitidos: $skippedCount"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Create GitHub Release
        if: steps.extract_version.outputs.HAS_MAIN == 'True' || steps.extract_version.outputs.HAS_SOURCEGEN == 'True'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.extract_version.outputs.MAIN_STABLE || steps.extract_version.outputs.SOURCEGEN_STABLE }}
          name: "Stable Release"
          prerelease: false
          body: |
            ## ğŸ‰ Stable Release
            
            Esta es una versiÃ³n estable promocionada desde preview.
            
            ### ğŸ“¦ Paquetes publicados
            ${{ steps.extract_version.outputs.HAS_MAIN == 'True' && format('- RandAMediaLabGroup.MauiPdfGenerator {0} (desde {1})', steps.extract_version.outputs.MAIN_STABLE, steps.extract_version.outputs.MAIN_PREVIEW) || '' }}
            ${{ steps.extract_version.outputs.HAS_SOURCEGEN == 'True' && format('- RandAMediaLabGroup.MauiPdfGenerator.SourceGenerators {0} (desde {1})', steps.extract_version.outputs.SOURCEGEN_STABLE, steps.extract_version.outputs.SOURCEGEN_PREVIEW) || '' }}
            
            ### ğŸ”— PR Original
            ${{ github.event.pull_request.html_url }}
            
            ### âœ¨ Cambios
             Ver el Pull Request para detalles completos de los cambios incluidos en esta versiÃ³n.
         env:
           GITHUB_TOKEN: ${{ secrets.INTERNAL_GITHUB_TOKEN }}
