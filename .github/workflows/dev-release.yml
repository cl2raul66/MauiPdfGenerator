name: Development Release (Preview)

on:
  pull_request:
    types: [closed]
    branches:
      - development

permissions:
  contents: write
  pull-requests: read

jobs:
  publish-preview:
    if: github.event.pull_request.merged == true
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract versions from PR body
        id: extract_version
        shell: pwsh
        run: |
          $prBody = @'
          ${{ github.event.pull_request.body }}
          '@

          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          Write-Host "Analizando cuerpo del PR"
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Buscar ver(main): x.x.x-preview
          $mainVersion = $null
          if ($prBody -match '(?i)ver\s*\(\s*main\s*\)\s*:\s*(\d+\.\d+\.\d+-preview)') {
            $mainVersion = $matches[1]
            Write-Host "ver(main): $mainVersion"
          } else {
            Write-Host "ver(main) no encontrado - se omitira paquete Core"
          }

          # Buscar ver(sourceGenerators): x.x.x-preview
          $sourceGenVersion = $null
          if ($prBody -match '(?i)ver\s*\(\s*sourceGenerators\s*\)\s*:\s*(\d+\.\d+\.\d+-preview)') {
            $sourceGenVersion = $matches[1]
            Write-Host "ver(sourceGenerators): $sourceGenVersion"
          } else {
            Write-Host "ver(sourceGenerators) no encontrado - se omitira paquete SourceGenerators"
          }

          # Validar que al menos uno fue encontrado
          if (-not $mainVersion -and -not $sourceGenVersion) {
            Write-Host ""
            Write-Host "No se encontró ninguna versión válida. Workflow terminado." 
            echo "::warning::No se encontraron versiones en el PR body" 
            echo "SKIP_WORKFLOW=true" >> $env:GITHUB_OUTPUT
            exit 0
          }

          # Exportar variables
          echo "MAIN_VERSION=$mainVersion" >> $env:GITHUB_OUTPUT
          echo "SOURCEGEN_VERSION=$sourceGenVersion" >> $env:GITHUB_OUTPUT
          echo "HAS_MAIN=$($null -ne $mainVersion)" >> $env:GITHUB_OUTPUT
          echo "HAS_SOURCEGEN=$($null -ne $sourceGenVersion)" >> $env:GITHUB_OUTPUT

          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Update project versions
        if: steps.extract_version.outputs.SKIP_WORKFLOW != 'true'
        shell: pwsh
        run: |
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          Write-Host "Actualizando versiones en proyectos"
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Actualizar MauiPdfGenerator
          if ("${{ steps.extract_version.outputs.HAS_MAIN }}" -eq "True") {
            $version = "${{ steps.extract_version.outputs.MAIN_VERSION }}"
            $coreProj = "MauiPdfGenerator/MauiPdfGenerator.csproj"
            (Get-Content $coreProj) -replace '<Version>.*</Version>', "<Version>$version</Version>" | Set-Content $coreProj
            Write-Host "Core actualizado a: $version"
          } else {
            Write-Host "Core omitido (no hay version)"
          }

          # Actualizar SourceGenerators
          if ("${{ steps.extract_version.outputs.HAS_SOURCEGEN }}" -eq "True") {
            $version = "${{ steps.extract_version.outputs.SOURCEGEN_VERSION }}"
            $sourceGenProj = "MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj"
            (Get-Content $sourceGenProj) -replace '<Version>.*</Version>', "<Version>$version</Version>" | Set-Content $sourceGenProj
            Write-Host "SourceGenerators actualizado a: $version"
          } else {
            Write-Host "SourceGenerators omitido (no hay version)"
          }

          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Setup .NET 10
        if: steps.extract_version.outputs.SKIP_WORKFLOW != 'true'  
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI Workloads
        if: steps.extract_version.outputs.SKIP_WORKFLOW != 'true'
        run: dotnet workload install maui --ignore-failed-sources
        timeout-minutes: 15

      - name: Build & Pack Core package
        if: steps.extract_version.outputs.HAS_MAIN == 'True'
        run: |
          dotnet restore MauiPdfGenerator/MauiPdfGenerator.csproj /p:Configuration=Release 
          dotnet build MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-restore
          dotnet pack MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-build --output ./nupkgs

      - name: Build & Pack SourceGenerators package
        if: steps.extract_version.outputs.HAS_SOURCEGEN == 'True'
        run: |
          dotnet restore MauiPdfGenerator/MauiPdfGenerator.SourceGenerators.csproj /p:Configuration=Release 
          dotnet build MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj --configuration Release --no-restore
          dotnet pack MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj --configuration Release --no-build --output ./nupkgs
      
      - name: List generated packages
        if: steps.extract_version.outputs.SKIP_WORKFLOW != 'true'
        shell: pwsh
        run: |
          Write-Host "Paquetes generados:"
          if (Test-Path ./nupkgs) {
            Get-ChildItem ./nupkgs/*.nupkg | ForEach-Object { Write-Host "  - $($_.Name)" }
          } else {
            Write-Host "  No se generaron paquetes"
          }

      - name: Publish to NuGet
        if: steps.extract_version.outputs.SKIP_WORKFLOW != 'true'
        shell: pwsh
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          if (-not (Test-Path ./nupkgs)) {
            Write-Host "No hay paquetes para publicar"
            exit 0
          }

          $packages = Get-ChildItem ./nupkgs/*.nupkg
          $publishedCount = 0
          $totalPackages = $packages.Count

          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          Write-Host "Publicando paquetes PREVIEW a NuGet"
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          foreach ($package in $packages) {
            Write-Host ""
            Write-Host "Procesando: $($package.Name)"

            try {
              dotnet nuget push $package.FullName --api-key $env:NUGET_API_KEY --source https://api.nuget.org/v3/index.json --skip-duplicate 2>&1
              
              $publishedCount++
            } catch {
              Write-Host "Error capturado: $($_.Exception.Message)"
            }
          }

          Write-Host ""
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          Write-Host "Resumen:"
          Write-Host "   Publicados: $publishedCount / $totalPackages"
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Create GitHub Release
        if: steps.extract_version.outputs.SKIP_WORKFLOW != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.extract_version.outputs.MAIN_VERSION || steps.extract_version.outputs.SOURCEGEN_VERSION }}
          name: "Preview Release"
          prerelease: true
          body: |
            ## Preview Release

            Esta es una version preview automatica desde development.

            ### Paquetes publicados
            ${{ steps.extract_version.outputs.HAS_MAIN == 'True' && format('- RandAMediaLabGroup.MauiPdfGenerator {0}', steps.extract_version.outputs.MAIN_VERSION) || '' }}
            ${{ steps.extract_version.outputs.HAS_SOURCEGEN == 'True' && format('- RandAMediaLabGroup.MauiPdfGenerator.SourceGenerators {0}', steps.extract_version.outputs.SOURCEGEN_VERSION) || '' }}

            ### PR Original
            ${{ github.event.pull_request.html_url }}
        env:
          GITHUB_TOKEN: ${{ secrets.INTERNAL_GITHUB_TOKEN }}
