name: Production Release (Stable)

permissions:
  contents: read
  pull-requests: write

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    paths:
      - 'MauiPdfGenerator/**'
      - 'MauiPdfGenerator.SourceGenerators/**'

jobs:
  integration-check:
    name: Pre-Release Checks
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      - name: Install MAUI Workloads
        run: dotnet workload install maui --ignore-failed-sources
      - name: Run Integration Tests
        run: dotnet test MauiPdfGenerator.IntegrationTests/MauiPdfGenerator.IntegrationTests.csproj --configuration Release --verbosity normal
  
  build-sourcegen:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.final_version.outputs.VAL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Calculate Version
        id: versioning
        uses: PaulHatch/semantic-version@v5.4.0
        with:
          tag_prefix: "gen-v"
          major_pattern: "!:|BREAKING CHANGE:"
          minor_pattern: "^feat"
          version_format: "${major}.${minor}.${patch}"
          change_path: "MauiPdfGenerator.SourceGenerators"
          user_format_type: "json"

      - name: Determine Version String
        id: final_version
        shell: pwsh
        run: |
          echo "VAL=${{ steps.versioning.outputs.version }}" >> $env:GITHUB_OUTPUT

      - name: Build & Pack
        run: |
          $ver = "${{ steps.final_version.outputs.VAL }}"
          Write-Host "Empaquetando SourceGen versiÃ³n: $ver"

          dotnet restore MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj
          dotnet build MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj --configuration Release --no-restore
          dotnet pack MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj --configuration Release --no-build --output ./output /p:Version=$ver

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sourcegen-package
          path: ./output/*.nupkg
          retention-days: 1

  build-main:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.final_version.outputs.VAL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install MAUI Workloads
        run: dotnet workload install maui --ignore-failed-sources
      
      - name: Calculate Version
        id: versioning
        uses: PaulHatch/semantic-version@v5.4.0
        with:
          tag_prefix: "main-v"
          major_pattern: "!:|BREAKING CHANGE:"
          minor_pattern: "^feat"
          version_format: "${major}.${minor}.${patch}"
          user_format_type: "json"

      - name: Determine Version String
        id: final_version
        shell: pwsh
        run: |
          echo "VAL=${{ steps.versioning.outputs.version }}" >> $env:GITHUB_OUTPUT

      - name: Build & Pack Main
        run: |
          $mainVer = "${{ steps.final_version.outputs.VAL }}"

          dotnet restore MauiPdfGenerator/MauiPdfGenerator.csproj /p:Configuration=Release /p:Version=$mainVer     
          dotnet build MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-restore /p:Version=$mainVer      
          dotnet pack MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-build --output ./output /p:Version=$mainVer

      - name: Upload Main Artifact
        uses: actions/upload-artifact@v4
        with:
          name: main-package
          path: ./output/*.nupkg
          retention-days: 1

  publish-nuget:
    needs: [build-main, build-sourcegen]
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./packages
          merge-multiple: true

      - name: Publish to NuGet
        shell: pwsh
        run: |
          $packages = Get-ChildItem ./packages/*.nupkg
          foreach ($pkg in $packages) {
              Write-Host "Publicando Stable: $($pkg.Name)"
              dotnet nuget push $pkg.FullName --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          }

      - name: Create Git Tags
        uses: actions/github-script@v7
        with:
          script: |
            const mainVer = "${{ needs.build-main.outputs.version }}";
            const genVer = "${{ needs.build-sourcegen.outputs.version }}";
            
            async function tryCreateTag(tagName) {
              try {
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/tags/${tagName}`,
                  sha: context.sha
                });
                console.log(`Tag creado: ${tagName}`);
              } catch (e) {
                console.log(`Tag ${tagName} no creado (ya existe o sin cambios).`);
              }
            }

            await tryCreateTag(`main-v${mainVer}`);
            await tryCreateTag(`gen-v${genVer}`);
