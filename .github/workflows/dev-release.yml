name: Development Release (Preview)

permissions:
  contents: write

on:
  push:
    branches: [ "development" ]
    paths:
      - 'MauiPdfGenerator/**'
      - 'MauiPdfGenerator.SourceGenerators/**'

env:
  DOTNET_VERSION: '10.0.x'
  CORE_PACKAGE: 'RandAMediaLabGroup.MauiPdfGenerator'
  SOURCEGEN_PACKAGE: 'RandAMediaLabGroup.MauiPdfGenerator.SourceGenerators'

jobs:
  analyze-commits:
    name: Analyze Commits & Calculate Versions
    runs-on: ubuntu-latest
    outputs:
      has_core_changes: ${{ steps.analyze.outputs.has_core_changes }}
      has_sourcegen_changes: ${{ steps.analyze.outputs.has_sourcegen_changes }}
      core_version: ${{ steps.core_version.outputs.version }}
      sourcegen_version: ${{ steps.sourcegen_version.outputs.version }}
      core_published_at: ${{ steps.core_version.outputs.published_at }}
      sourcegen_published_at: ${{ steps.sourcegen_version.outputs.published_at }}
      core_should_publish: ${{ steps.core_version.outputs.should_publish }}
      sourcegen_should_publish: ${{ steps.sourcegen_version.outputs.should_publish }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get commit messages
        id: commits
        run: |
          echo "commits=$(git log ${{ github.event.before }}..HEAD --oneline --format='%s' | tr '\n' ',')" >> $GITHUB_OUTPUT

      - name: Analyze commits for version bumps
        id: analyze
        shell: pwsh
        run: |
          $commits = "${{ steps.commits.outputs.commits }}"
          $hasCore = $false
          $hasSourcegen = $false

          # Tipos que disparan version bump: feat, fix, feat!, fix!
          # Scopes: core (MauiPdfGenerator), sourcegen (SourceGenerators)

          $commitList = $commits.Split(',', [StringSplitOptions]::RemoveEmptyEntries)

          foreach ($commit in $commitList) {
            $commit = $commit.Trim()
            Write-Host "Analizando commit: $commit"

            # Buscar patrones como: feat(core), fix(core), feat(core)!, fix(sourcegen)!, etc.
            if ($commit -match '^(feat|fix)(\((core|sourcegen)\))?!:') {
              # Breaking change con scope explícito
              $scope = $matches[3]
              if ($scope -eq 'core') {
                $hasCore = $true
                Write-Host "  ✓ Breaking change detected en scope: core"
              }
              elseif ($scope -eq 'sourcegen') {
                $hasSourcegen = $true
                Write-Host "  ✓ Breaking change detected en scope: sourcegen"
              }
            }
            elseif ($commit -match '^feat\(core\):') {
              $hasCore = $true
              Write-Host "  ✓ Feature en scope: core"
            }
            elseif ($commit -match '^fix\(core\):') {
              $hasCore = $true
              Write-Host "  ✓ Fix en scope: core"
            }
            elseif ($commit -match '^feat\(sourcegen\):') {
              $hasSourcegen = $true
              Write-Host "  ✓ Feature en scope: sourcegen"
            }
            elseif ($commit -match '^fix\(sourcegen\):') {
              $hasSourcegen = $true
              Write-Host "  ✓ Fix en scope: sourcegen"
            }
            elseif ($commit -match '^(feat|fix)!:') {
              # ❌ Breaking change SIN scope - FAIL FAST
              Write-Host ""
              Write-Host "╔════════════════════════════════════════════════════════════════════╗"
              Write-Host "║  ❌ ERROR: Breaking change sin scope especificado                  ║"
              Write-Host "╚════════════════════════════════════════════════════════════════════╝"
              Write-Host ""
              Write-Host "Commit inválido: $commit"
              Write-Host ""
              Write-Host "Los commits de breaking change DEBEN especificar el scope:"
              Write-Host ""
              Write-Host "  Para Core (MauiPdfGenerator):"
              Write-Host "    feat!(core): breaking change en core"
              Write-Host "    fix!(core):  breaking fix en core"
              Write-Host ""
              Write-Host "  Para SourceGenerators:"
              Write-Host "    feat!(sourcegen): breaking change en sourcegen"
              Write-Host "    fix!(sourcegen):  breaking fix en sourcegen"
              Write-Host ""
              Write-Host "Por favor, actualiza el mensaje del commit para especificar el scope."
              Write-Host ""
              exit 1
            }
          }

          "has_core_changes=$hasCore" >> $env:GITHUB_OUTPUT
          "has_sourcegen_changes=$hasSourcegen" >> $env:GITHUB_OUTPUT
          Write-Host ""
          Write-Host "════════════════════════════════════════════════════════════════════"
          Write-Host "Resumen de cambios:"
          Write-Host "  Core changes: $hasCore"
          Write-Host "  Sourcegen changes: $hasSourcegen"
          Write-Host "════════════════════════════════════════════════════════════════════"

      - name: Get Next Core Version
        id: core_version
        shell: pwsh
        run: |
          $hasChanges = "${{ steps.analyze.outputs.has_core_changes }}"
          if ($hasChanges -ne 'true') {
            echo "version=" >> $env:GITHUB_OUTPUT
            echo "published_at=" >> $env:GITHUB_OUTPUT
            echo "bump_type=" >> $env:GITHUB_OUTPUT
            echo "increment=" >> $env:GITHUB_OUTPUT
            echo "source=" >> $env:GITHUB_OUTPUT
            echo "should_publish=false" >> $env:GITHUB_OUTPUT
            exit 0
          }
          $result = & ./.github/scripts/Get-LatestPackageVersion.ps1 `
            -PackageName "${{ env.CORE_PACKAGE }}" `
            -Scope "core" `
            -Commits "${{ steps.commits.outputs.commits }}"

          echo "version=$($result.version)" >> $env:GITHUB_OUTPUT
          echo "published_at=$($result.published_at)" >> $env:GITHUB_OUTPUT
          echo "bump_type=$($result.bump_type)" >> $env:GITHUB_OUTPUT
          echo "increment=$($result.increment)" >> $env:GITHUB_OUTPUT
          echo "source=$($result.source)" >> $env:GITHUB_OUTPUT
          echo "should_publish=$($result.should_publish)" >> $env:GITHUB_OUTPUT

      - name: Get Next SourceGen Version
        id: sourcegen_version
        shell: pwsh
        run: |
          $hasChanges = "${{ steps.analyze.outputs.has_sourcegen_changes }}"
          if ($hasChanges -ne 'true') {
            echo "version=" >> $env:GITHUB_OUTPUT
            echo "published_at=" >> $env:GITHUB_OUTPUT
            echo "bump_type=" >> $env:GITHUB_OUTPUT
            echo "increment=" >> $env:GITHUB_OUTPUT
            echo "source=" >> $env:GITHUB_OUTPUT
            echo "should_publish=false" >> $env:GITHUB_OUTPUT
            exit 0
          }
          $result = & ./.github/scripts/Get-LatestPackageVersion.ps1 `
            -PackageName "${{ env.SOURCEGEN_PACKAGE }}" `
            -Scope "sourcegen" `
            -Commits "${{ steps.commits.outputs.commits }}"

          echo "version=$($result.version)" >> $env:GITHUB_OUTPUT
          echo "published_at=$($result.published_at)" >> $env:GITHUB_OUTPUT
          echo "bump_type=$($result.bump_type)" >> $env:GITHUB_OUTPUT
          echo "increment=$($result.increment)" >> $env:GITHUB_OUTPUT
          echo "source=$($result.source)" >> $env:GITHUB_OUTPUT
          echo "should_publish=$($result.should_publish)" >> $env:GITHUB_OUTPUT

  build-sourcegen:
    name: Build SourceGen Package
    needs: analyze-commits
    if: needs.analyze-commits.outputs.has_sourcegen_changes == 'true'
    runs-on: windows-latest
    outputs:
      version: ${{ steps.final_version.outputs.VAL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Determine Version String
        id: final_version
        shell: pwsh
        run: |
          $ver = "${{ needs.analyze-commits.outputs.sourcegen_version }}"
          echo "VAL=$ver" >> $env:GITHUB_OUTPUT
          Write-Host "SourceGen Version: $ver"

      - name: Build & Pack
        run: |
          $ver = "${{ steps.final_version.outputs.VAL }}"
          Write-Host "Empaquetando SourceGen versión: $ver"

          dotnet restore MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj
          dotnet build MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj --configuration Release --no-restore
          dotnet pack MauiPdfGenerator.SourceGenerators/MauiPdfGenerator.SourceGenerators.csproj --configuration Release --no-build --output ./output /p:Version=$ver

      - name: Upload SourceGen Package
        uses: actions/upload-artifact@v4
        with:
          name: sourcegen-package
          path: ./output/*.nupkg
          retention-days: 90

  build-main:
    name: Build Core Package
    needs: analyze-commits
    if: needs.analyze-commits.outputs.has_core_changes == 'true'
    runs-on: windows-latest
    outputs:
      version: ${{ steps.final_version.outputs.VAL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install MAUI Workloads
        run: dotnet workload install maui --ignore-failed-sources

      - name: Determine Version String
        id: final_version
        shell: pwsh
        run: |
          $ver = "${{ needs.analyze-commits.outputs.core_version }}"
          echo "VAL=$ver" >> $env:GITHUB_OUTPUT
          Write-Host "Core Version: $ver"

      - name: Build & Pack Main
        run: |
          $mainVer = "${{ steps.final_version.outputs.VAL }}"

          dotnet restore MauiPdfGenerator/MauiPdfGenerator.csproj /p:Configuration=Release /p:Version=$mainVer
          dotnet build MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-restore /p:Version=$mainVer
          dotnet pack MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --no-build --output ./output /p:Version=$mainVer

      - name: Upload Core Package
        uses: actions/upload-artifact@v4
        with:
          name: main-package
          path: ./output/*.nupkg
          retention-days: 90

  publish-nuget:
    name: Publish to NuGet & Update Version Artifact
    needs: [analyze-commits, build-main, build-sourcegen]
    if: needs.build-main.outputs.version != '' || needs.build-sourcegen.outputs.version != ''
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./packages
          merge-multiple: true

      - name: Publish to NuGet
        shell: pwsh
        run: |
          $packages = Get-ChildItem ./packages/*.nupkg
          if ($packages.Count -eq 0) {
            Write-Host "No packages to publish"
            exit 0
          }
          foreach ($pkg in $packages) {
            Write-Host "Publicando Preview: $($pkg.Name)"
            dotnet nuget push $pkg.FullName --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
          }

      - name: Prepare Version Artifact
        if: success()
        shell: pwsh
        run: |
          $coreVer = "${{ needs.build-main.outputs.version }}"
          $genVer = "${{ needs.build-sourcegen.outputs.version }}"
          $timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          $json = @{
            core = @{
              version = if ($coreVer) { $coreVer } else { $null }
              publishedAt = if ($coreVer) { $timestamp } else { $null }
            }
            sourcegen = @{
              version = if ($genVer) { $genVer } else { $null }
              publishedAt = if ($genVer) { $timestamp } else { $null }
            }
          }

          $json | ConvertTo-Json -Depth 3 | Out-File -FilePath "current-version.json" -Encoding utf8
          Write-Host "Contenido de current-version.json:"
          Get-Content "current-version.json"

      - name: Upload Version Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: current-version
          path: ./current-version.json
          retention-days: 90

      - name: Cleanup Old Version Artifacts
        if: always() && success()
        shell: pwsh
        run: |
          Write-Host "Buscando artifacts anteriores con nombre 'current-version'..."

          $artifacts = gh api repos/:owner/:repo/actions/artifacts `
            --jq '.artifacts[] | select(.name == "current-version") | .id' 2>$null

          if ([string]::IsNullOrWhiteSpace($artifacts)) {
            Write-Host "No se encontraron artifacts anteriores para eliminar."
          } else {
            $artifactIds = $artifacts | Out-String | Write-Output -NoNewline
            foreach ($id in $artifactIds.Split([Environment]::NewLine, [StringSplitOptions]::RemoveEmptyEntries)) {
              if ($id.Trim()) {
                Write-Host "Eliminando artifact: $id"
                gh api --method DELETE repos/:owner/:repo/actions/artifacts/$id 2>$null | Out-Null
                Write-Host "✓ Artifact $id eliminado"
              }
            }
          }

      - name: Report Version Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "════════════════════════════════════════════════════════════════════"
          Write-Host "RESUMEN DE PUBLICACIÓN"
          Write-Host "════════════════════════════════════════════════════════════════════"
          Write-Host "Core Version:       ${{ needs.build-main.outputs.version }}"
          Write-Host "SourceGen Version:  ${{ needs.build-sourcegen.outputs.version }}"
          Write-Host "════════════════════════════════════════════════════════════════════"

      - name: Format Core Commits for Release
        if: success() && needs.build-main.outputs.version != ''
        id: commits_core
        shell: pwsh
        run: |
          $commits = "${{ needs.analyze-commits.outputs.commits }}"
          $coreCommits = $commits -split ',' | Where-Object { $_ -match '\(core\)(\)!)?:' } | ForEach-Object { "- $_" }
          $formattedString = $coreCommits -join "`n"
          echo "commits_formatted=$formattedString" >> $env:GITHUB_OUTPUT

      - name: Format SourceGen Commits for Release
        if: success() && needs.build-sourcegen.outputs.version != ''
        id: commits_sourcegen
        shell: pwsh
        run: |
          $commits = "${{ needs.analyze-commits.outputs.commits }}"
          $sgCommits = $commits -split ',' | Where-Object { $_ -match '\(sourcegen\)(\)!)?:' } | ForEach-Object { "- $_" }
          $formattedString = $sgCommits -join "`n"
          echo "commits_formatted=$formattedString" >> $env:GITHUB_OUTPUT

      - name: Get Timestamp
        if: success() && (needs.build-main.outputs.version != '' || needs.build-sourcegen.outputs.version != '')
        id: timestamp
        shell: pwsh
        run: |
          $timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          echo "value=$timestamp" >> $env:GITHUB_OUTPUT

      - name: Create GitHub Release - Core
        if: success() && needs.build-main.outputs.version != ''
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.build-main.outputs.version }}
          name: Release ${{ needs.build-main.outputs.version }} (Preview - Core)
          body: |
            ## Commits Incluidos (Core)
            ${{ steps.commits_core.outputs.commits_formatted }}

            **Published at:** ${{ steps.timestamp.outputs.value }}
          draft: false
          prerelease: true
          update_existing: true

      - name: Create GitHub Release - SourceGen
        if: success() && needs.build-sourcegen.outputs.version != ''
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.build-sourcegen.outputs.version }}
          name: Release ${{ needs.build-sourcegen.outputs.version }} (Preview - SourceGen)
          body: |
            ## Commits Incluidos (SourceGen)
            ${{ steps.commits_sourcegen.outputs.commits_formatted }}

            **Published at:** ${{ steps.timestamp.outputs.value }}
          draft: false
          prerelease: true
          update_existing: true
