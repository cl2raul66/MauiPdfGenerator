name: Publish Main Library

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'MauiPdfGenerator/**'
      - '!MauiPdfGenerator.Diagnostics/**'      # Excluir carpetas hermanas
      - '!MauiPdfGenerator.SourceGenerators/**' # Excluir carpetas hermanas

jobs:
  deploy-main:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build & Pack
        run: |
          # dotnet pack compila implícitamente. 
          # Si Main depende de Diagnostics por ProjectReference, esto compilará ambos,
          # pero solo generará el .nupkg de Main en la carpeta de salida.
          dotnet pack MauiPdfGenerator/MauiPdfGenerator.csproj --configuration Release --output ./output

      - name: Publish to NuGet (Smart Check)
        shell: pwsh
        run: |
          $packages = Get-ChildItem ./output/*.nupkg
          if (-not $packages) { Write-Error "No se generó ningún paquete .nupkg"; exit 1 }

          $apiKey = "${{ secrets.NUGET_API_KEY }}"
          $source = "https://api.nuget.org/v3/index.json"

          foreach ($pkg in $packages) {
              Write-Host "Procesando: $($pkg.Name)"
              
              # Usamos Start-Process para mejor control del flujo de salida
              $proc = Start-Process -FilePath "dotnet" -ArgumentList "nuget push $($pkg.FullName) --api-key $apiKey --source $source --skip-duplicate" -NoNewWindow -PassThru -Wait
              
              if ($proc.ExitCode -eq 0) {
                  Write-Host "::notice title=Éxito::$($pkg.Name) procesado correctamente (o ya existía)."
              } else {
                  Write-Host "::error title=Error Crítico::Fallo al publicar $($pkg.Name)."
                  exit 1
              }
          }